@TRAP_SET
#DIM LCOUNT
VARSET LOCAL
IF TRAP:5 == FLAG:5 || TRAP:6 == FLAG:5 || TRAP:7 == FLAG:5
	DRAWLINE
	PRINTFORML 這個部屋已経設置了陷穽
	PRINTFORML 要撤去麼？
	PRINTFORML [1] 是
	PRINTFORML [0] 否
	$INPUT_LOOP
	INPUT
	SIF RESULT != 1
		RETURN
	IF TRAP:5 == FLAG:5
		TRAP:0 = 0
		TRAP:5 = 0
	ENDIF
	IF TRAP:6 == FLAG:5
		TRAP:1 = 0
		TRAP:6 = 0
	ENDIF
	IF TRAP:7 == FLAG:5
		TRAP:2 = 0
		TRAP:7 = 0
	ENDIF
	PRINTFORMW 撤去了陷穽！
	RETURN 1
ENDIF

FOR LCOUNT, 0, 20
SELECTCASE LCOUNT
	CASE 1
		LOCAL:LCOUNT = 100
		LOCALS:LCOUNT = 捕獣夾
	CASE 2
		LOCAL:LCOUNT = 150
		LOCALS:LCOUNT = 転送陷穽
	CASE 3
		LOCAL:LCOUNT = 300
		LOCALS:LCOUNT = 能量吸取
	CASE 10
		LOCAL:LCOUNT = 300
		LOCALS:LCOUNT = 触手落穴
	CASE 11
		LOCAL:LCOUNT = 300
		LOCALS:LCOUNT = 魔法拘束具
ENDSELECT
NEXT

DRAWLINE
PRINTFORML 要設置哪個陷穽？
PRINTFORML 現在的陷穽
IF TRAP:0
	PRINTFORML 陷穽1:%LOCALS:(TRAP:0), 15, LEFT% 場所:{TRAP:5}
ELSE
	PRINTFORML 無陷穽
ENDIF
SIF TRAP:1
	PRINTFORML 陷穽2:%LOCALS:(TRAP:1), 15, LEFT% 場所:{TRAP:6}
SIF TRAP:2
	PRINTFORML 陷穽3:%LOCALS:(TRAP:2), 15, LEFT% 場所:{TRAP:7}
DRAWLINE
FOR LCOUNT, 0, 20
	SIF !LOCAL:LCOUNT
		CONTINUE
	PRINTFORML [{LCOUNT}] %LOCALS:LCOUNT, 15, LEFT% 浄化力:{LOCAL:LCOUNT}
NEXT
PRINTFORML [0] 返回

$INPUT_LOOP2
INPUT

SIF RESULT == 0
	RETURN 0

SELECTCASE RESULT
	CASE 1, 2, 3, 10, 11
	CASEELSE
		REUSELASTLINE 不正な入力です
		GOTO INPUT_LOOP2
ENDSELECT

IF FLAG:6 < LOCAL:RESULT
	REUSELASTLINE 浄化力不足
	GOTO INPUT_LOOP2
ENDIF

PRINTFORMW %CALLNAME:1%設置了%LOCALS:RESULT%！
FLAG:6 -= LOCAL:RESULT
IF !TRAP:0
	TRAP:0 = RESULT
	TRAP:5 = FLAG:5
	RETURN 1
ENDIF

IF !TRAP:1
	TRAP:1 = RESULT
	TRAP:6 = FLAG:5
	RETURN 1
ENDIF

IF !TRAP:2
	TRAP:2 = RESULT
	TRAP:7 = FLAG:5
	RETURN 1
ENDIF
RETURN 1

@ENDPHASE_TRAP
#DIM LCOUNT
FOR LCOUNT, 0, 3
	SELECTCASE TRAP:LCOUNT
		CASE 1 TO 3
			CALL TRAP_SERCH_ENEMY(LCOUNT)
		CASE 10 TO 11
			CALL TRAP_SERCH_FRIEND(LCOUNT)
	ENDSELECT
NEXT

@TRAP_SERCH_ENEMY(ARG)
#DIM LCOUNT
VARSET LOCAL
FOR LCOUNT, 1, 100
	IF DA:LCOUNT:4 == TRAP:(ARG + 5) && DA:LCOUNT:4
		TRYCALLFORM TRAP_HIT_{TRAP:ARG}(ARG, LCOUNT)
		LOCAL ++
	ENDIF
NEXT
IF LOCAL
	TRAP:ARG = 0
	TRAP:(ARG + 5) = 0
ENDIF

@TRAP_SERCH_FRIEND(ARG)
#DIM LCOUNT
VARSET LOCAL
FOR LCOUNT, 2, CHARANUM
	IF CFLAG:LCOUNT:4 == TRAP:(ARG + 5) && LCOUNT != FLAG:10 && LCOUNT != FLAG:11
		TRYCALLFORM TRAP_HIT_{TRAP:ARG}(ARG, LCOUNT)
		LOCAL ++
	ENDIF
NEXT
IF LOCAL
	TRAP:ARG = 0
	TRAP:(ARG + 5) = 0
ENDIF

@TRAP_HIT_1(ARG, ARG:1)
PRINTFORMW %SAVESTR:(ARG:1)%中了{TRAP:(ARG + 5)}号部屋的捕獣夾陷穽！
DA:(ARG:1):1 = DA:(ARG:1):1 * 9 / 10 - (RAND:500 + 500)
SIF DA:(ARG:1):1 <= 0
	DA:(ARG:1):1 = 1

@TRAP_HIT_2(ARG, ARG:1)
PRINTFORMW %SAVESTR:(ARG:1)%中了{TRAP:(ARG + 5)}号部屋的転送陷穽！
DA:(ARG:1):4 = RAND:30 + 1

@TRAP_HIT_3(ARG, ARG:1)
PRINTFORMW %SAVESTR:(ARG:1)%中了{TRAP:(ARG + 5)}号部屋的能量吸取陷穽！
DA:(ARG:1):5 = DA:(ARG:1):5 * 9 / 10
SIF DA:(ARG:1):5 <= 0
	DA:(ARG:1):5 = 1

@TRAP_HIT_10(ARG, ARG:1)
PRINTFORMW %CALLNAME:(ARG:1)%中了{TRAP:(ARG+ 5)}号部屋的触手落穴！
	LOCAL:4 = 0
	CALL ADD_ABL_EXP(5, (ARG:1), 1000 + RAND:(ABL:(ARG:1):5 * 500 + 1))
	CALL PRINT_MESSAGE(1, 200, 138, CALLNAME:(ARG:1), "", 1)
	LOCAL:5 = 5 + RAND:4 + RAND:4
	FOR LOCAL:0, 0, LOCAL:5
		LOCAL:6 = RAND:4
		IF LOCAL:6 == 3
			CALL LOST_VIRGIN(1, 1, 4)
		ENDIF
		CALL EXTASY((ARG:1), LOCAL:6, RAND:50, 150)
	NEXT
	IF CFLAG:(ARG:1):22 == 0 && RAND:4 < 2 && TALENT:(ARG:1):0 == 0
		CALL RANDOM_PARASITE((ARG:1), 0, 0)
		IF RESULT
			CALL PRINT_MESSAGE(1, 200, 138, CALLNAME:(ARG:1), "", 3)
		ENDIF
	ELSEIF CFLAG:(ARG:1):22 == 0 && RAND:2 == 0 && TALENT:(ARG:1):0 == 0
		CALL RANDOM_PARASITE((ARG:1), 1, 0)
	ENDIF
	LOCAL:4 = 1
	WAIT

@TRAP_HIT_11(ARG, ARG:1)
PRINTFORMW %CALLNAME:(ARG:1)%中了{TRAP:(ARG+ 5)}号部屋的魔法拘束具！
CFLAG:(ARG:1):504 = 1